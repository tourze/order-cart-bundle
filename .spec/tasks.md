# Order Cart Bundle TDD 任务分解

## 阶段 1：基础架构（5个任务）

### 任务 1.1：创建 Bundle 结构和配置

#### 描述
创建基础的 Bundle 结构，包括目录结构、composer.json 配置、Bundle 主类和 PHPUnit 测试环境配置。

#### 验收标准（基于 EARS）
- 系统必须有正确的目录结构符合 Symfony Bundle 标准
- 当加载 Bundle 时，必须能够正确注册到 Symfony 容器
- 如果运行 PHPUnit，那么测试环境必须正确初始化

#### TDD 实施步骤
1. **红色阶段**：编写测试验证 Bundle 能够被加载
2. **绿色阶段**：创建 OrderCartBundle 类和基础配置
3. **重构阶段**：优化目录结构和配置文件

#### 测试场景
- 单元测试：Bundle 类可以被实例化
- 集成测试：Bundle 能被 Symfony 内核加载
- 边缘案例：配置文件缺失时的优雅处理

#### 依赖关系
- 需要：无
- 阻塞：所有其他任务

---

### 任务 1.2：创建异常类层次结构

#### 描述
实现自定义异常类，包括基础 CartException 和各种具体异常类型。

#### 验收标准（基于 EARS）
- 系统必须有 CartException 基类包含错误码
- 当抛出具体异常时，必须包含明确的错误码和消息
- 如果捕获异常，那么必须能获取错误码用于前端处理

#### TDD 实施步骤
1. **红色阶段**：编写测试验证异常类的错误码和消息
2. **绿色阶段**：实现异常类层次结构
3. **重构阶段**：确保异常类的一致性和可扩展性

#### 测试场景
- 单元测试：每个异常类返回正确的错误码
- 单元测试：异常消息格式化正确
- 边缘案例：嵌套异常的处理

#### 依赖关系
- 需要：任务 1.1
- 阻塞：所有 Service 层任务

---

### 任务 1.3：创建 DTO 类

#### 描述
实现数据传输对象，包括 CartSummaryDTO、ProductDTO 和 CartItemDTO。

#### 验收标准（基于 EARS）
- 系统必须有不可变的 DTO 类
- 当创建 DTO 时，必须验证必填字段
- 如果数据无效，那么构造函数必须抛出异常

#### TDD 实施步骤
1. **红色阶段**：编写测试验证 DTO 的不可变性和验证逻辑
2. **绿色阶段**：实现 DTO 类的构造函数和 getter 方法
3. **重构阶段**：添加 fromArray 和 toArray 方法便于序列化

#### 测试场景
- 单元测试：DTO 创建和数据访问
- 单元测试：必填字段验证
- 边缘案例：null 值和空数组的处理

#### 依赖关系
- 需要：任务 1.1
- 阻塞：任务 2.1, 2.2

---

### 任务 1.4：配置 ProductCoreBundle 依赖

#### 描述
配置与 Tourze\ProductCoreBundle 的依赖关系，确保 SKU 实体可以正确引用。

#### 验收标准（基于 EARS）
- Bundle 必须正确声明对 ProductCoreBundle 的依赖
- 能够访问和使用 \Tourze\ProductCoreBundle\Entity\Sku 实体
- Doctrine 必须正确配置实体关联

#### TDD 实施步骤
1. **红色阶段**：编写测试验证 SKU 实体可以被引用
2. **绿色阶段**：配置 composer.json 和 Doctrine 映射
3. **重构阶段**：优化依赖版本约束

#### 测试场景
- 单元测试：SKU 实体类存在性验证
- 集成测试：Doctrine 关联映射验证
- 边缘案例：SKU 实体不存在时的错误处理

#### 依赖关系
- 需要：任务 1.1
- 阻塞：任务 3.4, 所有涉及 SKU 的任务

---

### 任务 1.5：创建事件类

#### 描述
实现所有购物车事件类，包括 CartItemAddedEvent、CartItemUpdatedEvent 等。

#### 验收标准（基于 EARS）
- 系统必须有不可变的事件类
- 当创建事件时，必须包含完整的上下文信息
- 事件必须包含时间戳和用户信息

#### TDD 实施步骤
1. **红色阶段**：编写测试验证事件类的数据完整性
2. **绿色阶段**：实现事件类和必要的 getter 方法
3. **重构阶段**：添加事件基类减少重复代码

#### 测试场景
- 单元测试：事件创建和数据访问
- 单元测试：事件数据的不可变性
- 边缘案例：空上下文的处理

#### 依赖关系
- 需要：任务 1.1, 1.3
- 阻塞：任务 3.1, 3.2

---

## 阶段 2：接口定义（3个任务）

### 任务 2.1：定义 CartManagerInterface

#### 描述
创建购物车管理接口，定义所有 CRUD 操作的契约。

#### 验收标准（基于 EARS）
- Package 必须提供添加商品到购物车的功能，使用 Tourze\ProductCoreBundle\Entity\Sku 实体（U1）
- 当用户更新购物车商品数量时，Package 必须验证新数量的有效性（E2）
- 当用户删除购物车商品时，Package 必须触发相应事件（E3）

#### TDD 实施步骤
1. **红色阶段**：编写测试验证接口方法签名
2. **绿色阶段**：创建接口定义和 PHPDoc
3. **重构阶段**：优化方法签名和参数类型

#### 测试场景
- 单元测试：接口存在且方法签名正确
- 编译时检查：类型提示和返回类型
- 文档测试：PHPDoc 完整性

#### 依赖关系
- 需要：任务 1.1, 1.2, 1.3
- 阻塞：任务 3.1

---

### 任务 2.2：定义 CartDataProviderInterface

#### 描述
创建数据提供接口，供 order-checkout-bundle 等外部模块使用。

#### 验收标准（基于 EARS）
- Package 必须提供 CartDataProviderInterface 服务（U2）
- Package 必须支持按用户获取完整购物车信息（U3）
- Package 必须支持获取用户选中的购物车商品（U4）

#### TDD 实施步骤
1. **红色阶段**：编写测试验证接口的查询方法
2. **绿色阶段**：创建接口定义
3. **重构阶段**：优化返回类型和异常声明

#### 测试场景
- 单元测试：接口方法签名验证
- 集成测试准备：mock 实现测试
- 边缘案例：空结果集的返回类型

#### 依赖关系
- 需要：任务 1.1, 1.3
- 阻塞：任务 3.2

---

### 任务 2.3：定义 ProductProviderInterface

#### 描述
创建商品信息提供接口，定义外部系统需要实现的契约。

#### 验收标准（基于 EARS）
- 在查询购物车数据时，Package 必须实时获取商品的最新信息（O1）
- 接口必须支持单个和批量查询
- 接口必须包含可用性检查方法

#### TDD 实施步骤
1. **红色阶段**：编写测试验证接口契约
2. **绿色阶段**：创建接口定义
3. **重构阶段**：添加默认实现或适配器模式支持

#### 测试场景
- 单元测试：接口定义完整性
- Mock 测试：创建 mock 实现用于其他组件测试
- 边缘案例：SKU 不存在时的返回值

#### 依赖关系
- 需要：任务 1.1, 1.3
- 阻塞：任务 3.2, 3.3

---

## 阶段 3：核心实现（5个任务）

### 任务 3.1：实现 CartManager 服务

#### 描述
实现 CartManagerInterface，处理所有购物车 CRUD 操作的核心业务逻辑。

#### 验收标准（基于 EARS）
- 当商品添加到购物车时，Package 必须触发 CartItemAddedEvent 事件（E1）
- 当用户清空购物车时，Package 必须触发 CartClearedEvent 事件（E4）
- 当购物车为空时，Package 必须返回空的购物车对象而非 null（S1）

#### TDD 实施步骤
1. **红色阶段**：为每个方法编写失败的单元测试
2. **绿色阶段**：实现最小代码使测试通过
3. **重构阶段**：提取私有方法，优化代码结构

#### 测试场景
- 单元测试：添加商品功能（使用 SKU 实体、重复添加同一 SKU、数量合并）
- 单元测试：更新数量功能（有效数量、无效数量、权限验证）
- 单元测试：删除商品功能（存在的商品、不存在的商品）
- 单元测试：清空购物车功能
- 单元测试：事件触发验证
- 边缘案例：并发操作、事务处理

#### 依赖关系
- 需要：任务 2.1, 3.4, 3.5, 1.4
- 阻塞：任务 5.1

---

### 任务 3.2：实现 CartDataProvider 服务

#### 描述
实现 CartDataProviderInterface，提供购物车数据查询和汇总功能。

#### 验收标准（基于 EARS）
- Package 必须支持根据购物车项 ID 列表批量获取商品信息（U5）
- 当获取结算数据时，Package 必须只返回选中且有效的商品（S2）
- Package 必须实时获取商品的最新信息（O1）

#### TDD 实施步骤
1. **红色阶段**：编写查询功能的测试用例
2. **绿色阶段**：实现查询逻辑和数据聚合
3. **重构阶段**：优化查询性能，添加批量操作

#### 测试场景
- 单元测试：获取选中商品（有选中、无选中、部分选中）
- 单元测试：批量获取商品（存在的ID、不存在的ID、混合）
- 单元测试：购物车摘要计算（总价、总数量、选中统计）
- 集成测试：与 ProductProvider 的集成
- 性能测试：大量商品的查询性能

#### 依赖关系
- 需要：任务 2.2, 2.3, 3.4
- 阻塞：任务 5.2

---

### 任务 3.3：实现 CartValidator 服务

#### 描述
实现购物车验证服务，处理商品有效性检查、数量限制等验证逻辑。

#### 验收标准（基于 EARS）
- 如果购物车商品数超过配置限制，Package 必须拒绝添加新商品（C1）
- Package 必须对所有输入进行验证和清理（U18）
- 在配置了自定义验证器的情况下，Package 必须在添加商品前执行验证（O2）

#### TDD 实施步骤
1. **红色阶段**：编写验证逻辑的测试用例
2. **绿色阶段**：实现基础验证和扩展点
3. **重构阶段**：实现责任链模式支持多个验证器

#### 测试场景
- 单元测试：SKU 实体验证（有效 SKU 实体、无效 SKU 实体、未激活的 SKU）
- 单元测试：数量验证（正数、零、负数、超大值）
- 单元测试：购物车容量限制（未满、已满、临界值）
- 单元测试：自定义验证器集成
- 边缘案例：验证器优先级和执行顺序

#### 依赖关系
- 需要：任务 1.2, 4.1
- 阻塞：任务 3.1

---

### 任务 3.4：实现 CartItem 实体和 Repository

#### 描述
创建 CartItem 贫血模型实体和对应的 Repository，处理数据持久化。

#### 验收标准（基于 EARS）
- Package 必须将购物车数据持久化到数据库，包括 SKU 实体关联（U8）
- Package 必须支持多用户隔离的购物车数据管理（U9）
- Package 必须在 user_id 和 sku_id 字段上创建复合唯一索引（U27）

#### TDD 实施步骤
1. **红色阶段**：编写实体和 Repository 的测试
2. **绿色阶段**：实现实体类和基础 CRUD 操作
3. **重构阶段**：优化查询方法，添加批量操作

#### 测试场景
- 单元测试：实体 getter/setter 方法，特别是 SKU 实体关联
- 集成测试：Repository CRUD 操作，包括 SKU 实体的加载
- 集成测试：唯一索引约束验证（user_id + sku_id）
- 集成测试：用户数据隔离
- 性能测试：批量查询和更新，包括 JOIN 查询性能

#### 依赖关系
- 需要：任务 1.1, 1.3, 1.4
- 阻塞：任务 3.1, 3.2

---

### 任务 3.5：实现 Cart 虚拟实体

#### 描述
创建 Cart 聚合根实体，用于组织和管理多个 CartItem。

#### 验收标准（基于 EARS）
- 当购物车为空时，必须返回空的购物车对象而非 null（S1）
- Cart 必须提供便捷的方法访问购物车项
- Cart 必须能够计算总价和总数量

#### TDD 实施步骤
1. **红色阶段**：编写 Cart 聚合功能测试
2. **绿色阶段**：实现 Cart 类和聚合逻辑
3. **重构阶段**：添加便捷方法和计算属性

#### 测试场景
- 单元测试：空购物车创建
- 单元测试：购物车项聚合
- 单元测试：总价和数量计算
- 边缘案例：大量商品的性能

#### 依赖关系
- 需要：任务 3.4
- 阻塞：任务 3.1

---

## 阶段 4：扩展机制（3个任务）

### 任务 4.1：实现验证器扩展点

#### 描述
创建 CartItemValidatorInterface 和验证器管理机制，支持自定义验证逻辑。

#### 验收标准（基于 EARS）
- Package 必须提供商品验证器扩展点，验证 SKU 实体（U15）
- 在配置了自定义验证器的情况下，Package 必须在添加商品前执行验证（O2）
- 验证器必须支持优先级排序

#### TDD 实施步骤
1. **红色阶段**：编写验证器接口和管理器测试
2. **绿色阶段**：实现验证器链和优先级机制
3. **重构阶段**：添加验证器自动发现和注册

#### 测试场景
- 单元测试：验证器接口契约
- 单元测试：验证器链执行顺序
- 集成测试：自定义验证器注册和执行
- 边缘案例：验证器异常处理

#### 依赖关系
- 需要：任务 1.1
- 阻塞：任务 3.3

---

### 任务 4.2：实现数量限制器扩展点

#### 描述
创建 QuantityLimiterInterface 和限制器管理机制，支持自定义数量限制规则。

#### 验收标准（基于 EARS）
- Package 必须提供数量限制器扩展点（U16）
- 在配置了数量限制器的情况下，Package 必须强制执行数量限制（O3）
- 限制器必须支持按 SKU 实体和用户的差异化限制

#### TDD 实施步骤
1. **红色阶段**：编写限制器接口和实现测试
2. **绿色阶段**：实现默认限制器和扩展机制
3. **重构阶段**：添加配置驱动的限制规则

#### 测试场景
- 单元测试：限制器接口契约
- 单元测试：默认限制器实现
- 集成测试：自定义限制器集成
- 边缘案例：多个限制器的组合逻辑

#### 依赖关系
- 需要：任务 1.1
- 阻塞：任务 3.3

---

### 任务 4.3：实现事件订阅者示例

#### 描述
创建示例事件订阅者，展示如何监听和处理购物车事件。

#### 验收标准（基于 EARS）
- 当商品添加到购物车时，必须能够被外部监听（E1）
- 事件订阅者必须能够访问完整的事件上下文
- 必须提供清晰的集成示例

#### TDD 实施步骤
1. **红色阶段**：编写事件监听测试
2. **绿色阶段**：实现示例订阅者
3. **重构阶段**：添加更多事件处理示例

#### 测试场景
- 单元测试：事件订阅者注册
- 单元测试：事件处理逻辑
- 集成测试：完整的事件流程
- 文档测试：示例代码可运行

#### 依赖关系
- 需要：任务 1.4, 3.1
- 阻塞：任务 6.2

---

## 阶段 5：框架集成（3个任务）

### 任务 5.1：Symfony Bundle 集成

#### 描述
实现 Symfony Bundle 的完整集成，包括服务配置、依赖注入和自动装配。

#### 验收标准（基于 EARS）
- Package 必须自动注册所有必要的服务到 Symfony 容器（U22）
- Package 必须使用自动装配减少配置复杂度（U23）
- 配置必须通过环境变量 $_ENV 读取

#### TDD 实施步骤
1. **红色阶段**：编写 Bundle 集成测试
2. **绿色阶段**：实现服务配置和容器编译
3. **重构阶段**：优化服务定义，添加别名

#### 测试场景
- 集成测试：Bundle 加载和服务注册
- 集成测试：依赖注入和自动装配
- 集成测试：环境变量配置读取
- 边缘案例：配置缺失时的默认值

#### 依赖关系
- 需要：任务 3.1, 3.2
- 阻塞：任务 6.3

---

### 任务 5.2：Laravel ServiceProvider 集成

#### 描述
创建 Laravel ServiceProvider，支持在 Laravel 项目中使用购物车功能。

#### 验收标准（基于 EARS）
- Package 必须提供 Laravel 集成支持
- ServiceProvider 必须正确注册所有服务
- 必须支持 Laravel 的配置发布机制

#### TDD 实施步骤
1. **红色阶段**：编写 ServiceProvider 测试
2. **绿色阶段**：实现服务注册和配置发布
3. **重构阶段**：添加 Facade 支持

#### 测试场景
- 单元测试：ServiceProvider 注册逻辑
- 集成测试：在 Laravel 容器中的服务解析
- 集成测试：配置发布和合并
- 边缘案例：版本兼容性

#### 依赖关系
- 需要：任务 3.1, 3.2
- 阻塞：任务 6.3

---

### 任务 5.3：创建 CLI 命令

#### 描述
实现清理过期购物车项的命令行工具。

#### 验收标准（基于 EARS）
- Package 必须支持自动清理过期商品
- 命令必须支持 dry-run 模式
- 命令必须提供详细的执行报告

#### TDD 实施步骤
1. **红色阶段**：编写命令执行测试
2. **绿色阶段**：实现清理逻辑和输出
3. **重构阶段**：添加进度条和统计信息

#### 测试场景
- 单元测试：命令参数解析
- 单元测试：清理逻辑（过期判断、批量删除）
- 集成测试：实际清理操作
- 边缘案例：大量数据的处理

#### 依赖关系
- 需要：任务 3.4
- 阻塞：任务 6.3

---

## 阶段 6：文档和示例（3个任务）

### 任务 6.1：编写 README 和安装指南

#### 描述
创建完整的 README 文档，包括安装步骤、基础使用和配置说明。

#### 验收标准（基于 EARS）
- README 必须包含安装和基础使用说明
- 所有配置选项必须有详细说明
- 必须包含从耦合版本的迁移指南

#### TDD 实施步骤
1. **红色阶段**：列出所有需要文档化的内容
2. **绿色阶段**：编写基础文档
3. **重构阶段**：添加示例代码和最佳实践

#### 测试场景
- 文档测试：示例代码可执行
- 文档测试：配置示例正确
- 用户测试：新用户能够按照文档完成安装

#### 依赖关系
- 需要：任务 5.1, 5.2, 5.3
- 阻塞：发布

---

### 任务 6.2：创建集成示例

#### 描述
提供与 order-checkout-bundle 的完整集成示例。

#### 验收标准（基于 EARS）
- 必须展示如何使用 CartDataProviderInterface（U20）
- 必须展示事件监听的集成方式
- 必须包含直接结算的示例（U21）

#### TDD 实施步骤
1. **红色阶段**：编写集成场景测试
2. **绿色阶段**：实现示例代码
3. **重构阶段**：优化示例，添加注释

#### 测试场景
- 集成测试：完整的购物车到结算流程
- 集成测试：事件监听和处理
- 文档测试：示例代码完整性

#### 依赖关系
- 需要：任务 4.3, 5.1
- 阻塞：任务 6.3

---

### 任务 6.3：性能测试和优化

#### 描述
编写性能测试套件，验证并优化查询性能。

#### 验收标准（基于 EARS）
- Package 必须在 100ms 内完成购物车查询操作（P2）
- 添加商品操作必须小于 50ms
- 必须支持 100 个商品的购物车（P1）

#### TDD 实施步骤
1. **红色阶段**：编写性能基准测试
2. **绿色阶段**：优化查询和索引
3. **重构阶段**：添加查询缓存和批量操作

#### 测试场景
- 性能测试：100 商品购物车查询
- 性能测试：批量添加商品
- 性能测试：并发操作
- 压力测试：极限容量测试

#### 依赖关系
- 需要：所有核心功能任务
- 阻塞：发布

---

## 任务统计

### 按阶段分布
- **基础架构**：5 个任务
- **接口定义**：3 个任务
- **核心实现**：5 个任务
- **扩展机制**：3 个任务
- **框架集成**：3 个任务
- **文档示例**：3 个任务

### 总计：22 个任务

## 质量保证检查点

### 每个任务完成后必须：
1. ✅ 运行 PHPStan Level 8 静态分析（零错误）
2. ✅ 运行 PHPUnit 测试（100% 通过）
3. ✅ 运行 PHP-CS-Fixer 代码格式化
4. ✅ 验证测试覆盖率（≥90%）

### 关键里程碑：
- **阶段 1-2 完成**：基础架构和接口定义就绪
- **阶段 3 完成**：核心功能可用
- **阶段 4-5 完成**：完整功能和框架集成
- **阶段 6 完成**：生产就绪

## 实施建议

### 开发顺序
1. 严格按照任务依赖关系执行
2. 每个阶段完成后进行集成测试
3. 保持测试先行的 TDD 节奏

### 时间估算
- 每个任务：2-4 小时
- 总工时：约 42-84 小时
- 建议周期：2-3 周（考虑测试和文档）

### 风险管理
- **技术风险**：Doctrine 配置复杂性 → 提前验证实体映射
- **性能风险**：大量商品查询 → 早期进行性能测试
- **集成风险**：与现有系统冲突 → 保持向后兼容

## 成功标准

### 功能完整性
- [ ] 所有 EARS 需求已实现
- [ ] 所有接口已定义并实现
- [ ] 扩展机制工作正常

### 质量标准
- [ ] PHPStan Level 8 零错误
- [ ] 测试覆盖率 ≥90%
- [ ] 所有测试通过
- [ ] 代码符合 PSR-12 规范

### 集成验证
- [ ] Symfony Bundle 集成成功
- [ ] Laravel ServiceProvider 工作正常
- [ ] 与 order-checkout-bundle 集成验证

### 文档完整性
- [ ] README 完整清晰
- [ ] 所有配置有说明
- [ ] 示例代码可运行
- [ ] API 文档完整